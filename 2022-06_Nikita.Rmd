---
title: "2022-06_Nikita"
author: "T.L"
date: '2022-06-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}

packrat::init()

```



```{r}

library(tidyverse)

library(janitor)

library(MASS)

library(rstatix)

library(coin)

library(ggpubr)

library(Hmisc)

library(corrplot)

library(foreign)

library(reshape2)

library(flexplot)

library(brant)

library(effects)

library(VGAM)

library(nnet)

library(effects)

```


```{r}
#### Read in the data ####

vacdf <- read.csv("NikitaData.csv")

vacdf <- clean_names(vacdf)

## Check variables

vacdf$frame <- as.factor(vacdf$frame)

vacdf$age_grp <- as.factor(vacdf$age_grp)

vacdf.long <- pivot_longer(vacdf, cols = 14:15, names_to = "vaccine", values_to = "willingness")

structure(vacdf.long)

```


```{r}
#### Signed rank test to check preference between vaccines ####

test1 <- wilcox.test(vacdf$will_pf, vacdf$will_as_z, paired = TRUE)

test1


## If you get an error about dataframe - make sure package is specified for
## wilcox_test

stat.test <- vacdf.long %>% 
  rstatix::wilcox_test(willingness ~ vaccine, paired = TRUE) %>%
  add_significance()
stat.test

rstatix::wilcox_effsize(vacdf.long, willingness ~ vaccine,paired = TRUE)

### Significant


p <- ggboxplot(vacdf.long, x = "vaccine", y = "willingness",
          color = "vaccine", palette = "jco",
          add = "jitter")
#  Add p-value
p + stat_compare_means()

## Barplot to mimic one in paper

other_table <- xtabs(~vaccine + willingness , data = vacdf.long) 

barplot(other_table,
        main = "Grouped barchart",
        xlab = "vaccine", ylab = "frequency",
        col = c("darkgrey", "darkblue"),
        legend.text = rownames(other_table),
        beside = TRUE) # Grouped bars

```


```{r}

#### Intercorrelations ####

## Split by vaccine

astra <- filter(vacdf.long, vaccine == "will_as_z")

pfizer <- filter(vacdf.long, vaccine == "will_pf")

## Astra Z intercorrelations

## Dummy code frame

astra$frame <- ifelse(astra$frame == "Positive", 1, 0)

astra <- select(astra, "willingness","age", "frame", "risk_perception", "bis", "bas", "vax")

az_cor <- cor(astra, method = "kendall")

pfizer$frame <- ifelse(pfizer$frame == "Positive", 1, 0)

pfizer <- select(pfizer, "willingness","age", "frame", "risk_perception", "bis", "bas", "vax")

pf_cor <- cor(pfizer, method = "kendall")

### Check individually ###

## Astra

az_age <- cor.test(astra$age, astra$willingness, method = "kendall")

az_age

az_frame <- cor.test(astra$frame, astra$willingness, method = "kendall")

az_frame

az_risk <- cor.test(astra$risk_perception, astra$willingness, method = "kendall")

az_risk

az_bis <- cor.test(astra$bis, astra$willingness, method = "kendall")

az_bis

az_bas <- cor.test(astra$bas, astra$willingness, method = "kendall")

az_bas

az_vax <- cor.test(astra$vax, astra$willingness, method = "kendall")

az_vax

## Pfizer

pf_age <- cor.test(pfizer$age, pfizer$willingness, method = "kendall")

pf_age

pf_frame <- cor.test(pfizer$frame, pfizer$willingness, method = "kendall")

pf_frame

pf_risk <- cor.test(pfizer$risk_perception, pfizer$willingness, method = "kendall")

pf_risk

pf_bis <- cor.test(pfizer$bis, pfizer$willingness, method = "kendall")

pf_bis

pf_bas <- cor.test(pfizer$bas, pfizer$willingness, method = "kendall")

pf_bas

pf_vax <- cor.test(pfizer$vax, pfizer$willingness, method = "kendall")

pf_vax

## Others that had discrepency

vacdf.long$frame <- ifelse(vacdf.long$frame == "Positive", 1, 0)

age_frame <- cor.test(vacdf.long$age, vacdf.long$frame, method = "kendall")

age_frame

age_bis <- cor.test(vacdf.long$age, vacdf.long$bis, method = "kendall")

age_bis

age_bas <- cor.test(vacdf.long$age, vacdf.long$bas, method = "kendall")

age_bas

frame_risk <- cor.test(vacdf.long$frame, vacdf.long$risk_perception, method = "kendall")

frame_risk

frame_vax <- cor.test(vacdf.long$frame, vacdf.long$vax, method = "kendall")

frame_vax 

risk_bis <- cor.test(vacdf.long$risk_perception, vacdf.long$bis, method = "kendall")

risk_bis

risk_bas <- cor.test(vacdf.long$risk_perception, vacdf.long$bas, method = "kendall")

risk_bas

bis_vax <- cor.test(vacdf.long$bis, vacdf.long$vax, method = "kendall")

bis_vax

bas_vax <- cor.test(vacdf.long$bas, vacdf.long$vax, method = "kendall")

bas_vax

### Check Ms and SDs

astra %>% 
  get_summary_stats(willingness, type = "mean_sd")

pfizer %>% 
  get_summary_stats(willingness, type = "mean_sd")

vacdf.long %>% 
  get_summary_stats(c(age, frame, risk_perception, bis, bas, vax), type = "mean_sd")


```



```{r}
# Visualise willingness between the vaccines

flexplot(willingness~vaccine, data=vacdf.long, spread="sterr")

flexplot(age~1, data=vacdf.long)

### Univariate plots for astra data

structure(astra)

summary(astra)

## Astra visualisations

flexplot(willingness~1, data=astra)

flexplot(age~1, data=astra)

flexplot(vax~1, data=astra)

flexplot(frame~1, data = astra)

flexplot(bis~1, data = astra)

flexplot(bas~1, data = astra)

flexplot(risk_perception~1, data = astra)

## Bivariate visualisations

flexplot(willingness~age, data = astra)

flexplot(willingness~frame, data = astra)

flexplot(willingness~vax, data = astra)

flexplot(willingness~bis, data = astra)

flexplot(willingness~bas, data = astra)

flexplot(willingness~risk_perception, data = astra)

### Look for interactions for H1 - Age and frame interaction on willingness

astra_p1 = flexplot(willingness~age + frame | vax, data = astra)

marginal_plot(astra_p1)

astra_p2 = flexplot(willingness~age + vax | frame, data = astra)

marginal_plot(astra_p2)

astra_p3 = flexplot(willingness~vax + age | frame, data = astra)

marginal_plot(astra_p3)

astra_p4 = flexplot(willingness~frame + age | vax, data = astra)

marginal_plot(astra_p4)

astra_p5 = flexplot(willingness~vax + frame | age, data = astra)

marginal_plot(astra_p4)


astra_a1 = flexplot(willingness~age + bis | vax, data = astra)

marginal_plot(astra_a1)

astra_a2 = flexplot(willingness~age + vax | bis, data = astra)

marginal_plot(astra_a2)

astra_a3 = flexplot(willingness~bis + age | vax, data = astra)

marginal_plot(astra_a3)

```


```{r}
## Centre variables?

astra$age_scaled <- astra$age - mean(astra$age, na.rm=TRUE)

astra$vax_scaled <- astra$vax - mean(astra$vax, na.rm=TRUE)

flexplot(willingness~age_scaled, data = astra) ## The plots do not seem changed by centreing


###  GLM for hypothesis 1 - gain frame messages will increase willingness as age increases (interaction)

astra_mod1 = lm(willingness~vax_scaled + age_scaled*frame, data = astra)

visualize(astra_mod1, plot="model")

visualize(astra_mod1)

## Do not look normal or linear...

## Try robust model

astra_mod2 = rlm(willingness~vax_scaled + age_scaled*frame, data = astra)

visualize(astra_mod1, plot = "model")

visualize(astra_mod2, plot = "model")

visualize(astra_mod2, plot = "residuals")

## Try ordinal logistic regression

# Set factors

astra$willingnessfactor <- as.factor(astra$willingness)

levels(astra$willingnessfactor) <-  c("Definitely would not", "Probably would not", "Might or might not", "Probably would", "Definitely would")

astra_mod3 = polr(willingnessfactor~vax_scaled + age_scaled*frame, data = astra, Hess=TRUE)

brant(astra_mod3)

##### Proportional odds assumption violated ######

## Another check for proportional odds assumption ##

sf <- function(y){
  c('Y>=1' = qlogis(mean(y >= 1)),
    'Y>=2' = qlogis(mean(y >= 2)),
    'Y>=3' = qlogis(mean(y >= 3)),
    'Y>=4' = qlogis(mean(y >= 4)),
    'Y>=5' = qlogis(mean(y >= 5)))
    }

(s1 <- with(astra, summary(as.numeric(willingness) ~ vax_scaled + age_scaled*frame, fun=sf)))

glm(I(as.numeric(willingness) >= 2) ~ vax_scaled, family="binomial", data = astra)

glm(I(as.numeric(willingness) >= 3) ~ vax_scaled, family="binomial", data = astra)

glm(I(as.numeric(willingness) >= 4) ~ vax_scaled, family="binomial", data = astra)

glm(I(as.numeric(willingness) >= 5) ~ vax_scaled, family="binomial", data = astra)

## Normalise first set of coefficients to be 0

s1[, 4] <- s1[, 4] - s1[, 5]
s1[, 5] <- s1[, 5] - s1[, 5]
s1 # print

plot(s1, which=1:5, pch=1:5, xlab='logit', main=' ', xlim=range(s1[,3:5]))

## Proportional odds assumption seems violated...


summary(astra_mod3)

summary(astra_mod2)


### Visualisations of log model

Effect(focal.predictors = "frame",astra_mod3)
plot(Effect(focal.predictors = "age_scaled",astra_mod3))
plot(Effect(focal.predictors = c("frame", "age_scaled"),astra_mod3))

### Try model using vglm as you can specify false for parallel slops

astra_mod4 = vglm(willingnessfactor~vax_scaled + age_scaled*frame, data = astra, family = cumulative(parallel = FALSE))

summary(astra_mod4)
summary(astra_mod3)

summary(astra_mod4) ### Hauck-Donner effect

## Add in risk perception to the model

astra$risk_perceptionfactor <- as.factor(astra$risk_perception)

astra_mod5 = polr(willingnessfactor~vax_scaled + risk_perceptionfactor + age_scaled*frame, data = astra, Hess=TRUE)

brant(astra_mod5)

summary(astra_mod5)

## To get pvalues...

(az_ctable1 <- coef(summary(astra_mod5)))

## calculate and store p values
az_p1 <- pnorm(abs(az_ctable1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(az_ctable1 <- cbind(az_ctable1, "p value" = az_p1))

## Confidence intervals

(az_ci1 <- confint(astra_mod5))

## odds ratios
exp(coef(astra_mod5))


### Alternative hypothesis 1 - less bis and bas with age will have less effect on willingness

astra$bis_scaled <- astra$bis - mean(astra$bis, na.rm=TRUE)

astra$bas_scaled <- astra$bas - mean(astra$bas, na.rm=TRUE)

astra_modA1 = polr(willingnessfactor~vax_scaled + risk_perceptionfactor + bis_scaled*age_scaled + bis_scaled*frame + 
                     bas_scaled*age_scaled + bas_scaled*frame, data = astra, Hess=TRUE)

summary(astra_modA1)

brant(astra_modA1) # vax and bis*age significant

## To get pvalues...

(az_ctable2 <- coef(summary(astra_modA1)))

## calculate and store p values
az_p2 <- pnorm(abs(az_ctable2[, "t value"]), lower.tail = FALSE) * 2

## combined table
(az_ctable2 <- cbind(az_ctable2, "p value" = az_p2))

## Confidence intervals

(az_ci1 <- confint(astra_modA1))

## odds ratios
exp(coef(astra_modA1))

# Without the bis/bas frame interactions

astra_modA2 = polr(willingnessfactor~vax_scaled + risk_perceptionfactor + bis_scaled*age_scaled + 
                     bas_scaled*age_scaled, data = astra, Hess=TRUE)

summary(astra_modA2)


## To get pvalues...

(az_ctable3 <- coef(summary(astra_modA2)))

## calculate and store p values
az_p3 <- pnorm(abs(az_ctable3[, "t value"]), lower.tail = FALSE) * 2

## combined table
(az_ctable3 <- cbind(az_ctable3, "p value" = az_p3))


```


```{r}

### Look at Astra multinomial models ###

astramlm1 <- multinom(willingnessfactor~vax_scaled + risk_perceptionfactor + age_scaled*frame, data = astra)

G1 <- -2 * (logLik(astra_mod5)[1] - logLik(astramlm1)[1])
pchisq(G1, df = length(astra_mod5$zeta) - 1, lower.tail = FALSE)

### Above code tests whether the proportional odds model fits differently than the multinomial one.
### As this is significant, the null hypothesis, that the PO model fits differently, is rejected.

summary(astramlm1)

# Check the Z-score for the model (wald Z)
z1 <- summary(astramlm1)$coefficients/summary(astramlm1)$standard.errors

# 2-tailed z test
p1 <- (1 - pnorm(abs(z1), 0, 1)) * 2
p1

# Test the goodness of fit
chisq.test(astra$willingnessfactor,predict(astramlm1))

### With BIS and BAS ####

astramlm2 <- multinom(willingnessfactor~vax_scaled + risk_perceptionfactor +  bis_scaled*age_scaled + bis_scaled*frame +
                     bas_scaled*age_scaled + bas_scaled*frame, data = astra)

summary(astramlm2)

# Check the Z-score for the model (wald Z)
z2 <- summary(astramlm2)$coefficients/summary(astramlm2)$standard.errors

# 2-tailed z test
p2 <- (1 - pnorm(abs(z2), 0, 1)) * 2
p2

# Test the goodness of fit
chisq.test(astra$willingnessfactor,predict(astramlm2))

## Model with all of the interactions

astramlm3 <- multinom(willingnessfactor~vax_scaled + risk_perceptionfactor + age_scaled*frame + bis_scaled*age_scaled + bis_scaled*frame +
                     bas_scaled*age_scaled + bas_scaled*frame, data = astra)

summary(astramlm3)

# Check the Z-score for the model (wald Z)
z3 <- summary(astramlm3)$coefficients/summary(astramlm3)$standard.errors

# 2-tailed z test
p3 <- (1 - pnorm(abs(z3), 0, 1)) * 2
p3

# Test the goodness of fit
chisq.test(astra$willingnessfactor,predict(astramlm3))

plot(Effect("age_scaled",astramlm3),multiline=T)
#shows multiple lines of predictions in the same plot

plot(Effect("bis_scaled",astramlm3),multiline=T)

plot(Effect("bas_scaled",astramlm3),multiline=T)

plot(Effect("frame",astramlm3),multiline=T)

plot(Effect("risk_perceptionfactor",astramlm3),multiline=T)

```


```{r}
### Pfizer regression analyses ###

## Visualisations

flexplot(willingness~age, data=pfizer)

added.plot(willingness~vax + age, data=pfizer)

flexplot(willingness~frame, data=pfizer)

flexplot(willingness~risk_perception, data=pfizer)

flexplot(willingness~bis, data=pfizer)

flexplot(willingness~bas, data=pfizer)

flexplot(willingness~vax, data=pfizer)

flexplot(willingness~age + frame, data=pfizer, method="lm")

flexplot(willingness~age | bis, data=pfizer, method="lm")

flexplot(willingness~age | bas, data=pfizer, method="lm")

flexplot(willingness~bis + frame, data=pfizer, method="lm")

flexplot(willingness~bas + frame, data=pfizer, method="lm")

```
