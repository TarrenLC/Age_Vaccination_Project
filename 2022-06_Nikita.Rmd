---
title: "2022-06_Nikita"
author: "T.L"
date: '2022-06-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}

packrat::init()

```



```{r}

library(tidyverse)

library(janitor)

library(MASS)

library(rstatix)

library(coin)

library(ggpubr)

library(Hmisc)

library(corrplot)

library(foreign)

library(reshape2)

library(ordinal)

library(oglmx)

library(flexplot)

library(brant)

library(effects)

library(VGAM)

```


```{r}
#### Read in the data ####

vacdf <- read.csv("NikitaData.csv")

vacdf <- clean_names(vacdf)

## Check variables

vacdf$frame <- as.factor(vacdf$frame)

vacdf$age_grp <- as.factor(vacdf$age_grp)

vacdf.long <- pivot_longer(vacdf, cols = 14:15, names_to = "vaccine", values_to = "willingness")

structure(vacdf.long)

```


```{r}
#### Signed rank test to check preference between vaccines ####

test1 <- wilcox.test(vacdf$will_pf, vacdf$will_as_z, paired = TRUE)

test1


## If you get an error about dataframe - make sure package is specified for
## wilcox_test

stat.test <- vacdf.long %>% 
  rstatix::wilcox_test(willingness ~ vaccine, paired = TRUE) %>%
  add_significance()
stat.test

rstatix::wilcox_effsize(vacdf.long, willingness ~ vaccine,paired = TRUE)

### Significant


p <- ggboxplot(vacdf.long, x = "vaccine", y = "willingness",
          color = "vaccine", palette = "jco",
          add = "jitter")
#  Add p-value
p + stat_compare_means()

## Barplot to mimic one in paper

other_table <- xtabs(~vaccine + willingness , data = vacdf.long) 

barplot(other_table,
        main = "Grouped barchart",
        xlab = "vaccine", ylab = "frequency",
        col = c("darkgrey", "darkblue"),
        legend.text = rownames(other_table),
        beside = TRUE) # Grouped bars

```


```{r}

#### Intercorrelations ####

## Split by vaccine

astra <- filter(vacdf.long, vaccine == "will_as_z")

pfizer <- filter(vacdf.long, vaccine == "will_pf")

## Astra Z intercorrelations

## Dummy code frame

astra$frame <- ifelse(astra$frame == "Positive", 1, 0)

astra <- select(astra, "willingness","age", "frame", "risk_perception", "bis", "bas", "vax")

az_cor <- cor(astra, method = "kendall")

pfizer$frame <- ifelse(pfizer$frame == "Positive", 1, 0)

pfizer <- select(pfizer, "willingness","age", "frame", "risk_perception", "bis", "bas", "vax")

pf_cor <- cor(pfizer, method = "kendall")

### Check individually ###

## Astra

az_age <- cor.test(astra$age, astra$willingness, method = "kendall")

az_age

az_frame <- cor.test(astra$frame, astra$willingness, method = "kendall")

az_frame

az_risk <- cor.test(astra$risk_perception, astra$willingness, method = "kendall")

az_risk

az_bis <- cor.test(astra$bis, astra$willingness, method = "kendall")

az_bis

az_bas <- cor.test(astra$bas, astra$willingness, method = "kendall")

az_bas

az_vax <- cor.test(astra$vax, astra$willingness, method = "kendall")

az_vax

## Pfizer

pf_age <- cor.test(pfizer$age, pfizer$willingness, method = "kendall")

pf_age

pf_frame <- cor.test(pfizer$frame, pfizer$willingness, method = "kendall")

pf_frame

pf_risk <- cor.test(pfizer$risk_perception, pfizer$willingness, method = "kendall")

pf_risk

pf_bis <- cor.test(pfizer$bis, pfizer$willingness, method = "kendall")

pf_bis

pf_bas <- cor.test(pfizer$bas, pfizer$willingness, method = "kendall")

pf_bas

pf_vax <- cor.test(pfizer$vax, pfizer$willingness, method = "kendall")

pf_vax

## Others that had discrepency

vacdf.long$frame <- ifelse(vacdf.long$frame == "Positive", 1, 0)

age_frame <- cor.test(vacdf.long$age, vacdf.long$frame, method = "kendall")

age_frame

age_bis <- cor.test(vacdf.long$age, vacdf.long$bis, method = "kendall")

age_bis

age_bas <- cor.test(vacdf.long$age, vacdf.long$bas, method = "kendall")

age_bas

frame_risk <- cor.test(vacdf.long$frame, vacdf.long$risk_perception, method = "kendall")

frame_risk

frame_vax <- cor.test(vacdf.long$frame, vacdf.long$vax, method = "kendall")

frame_vax 

risk_bis <- cor.test(vacdf.long$risk_perception, vacdf.long$bis, method = "kendall")

risk_bis

risk_bas <- cor.test(vacdf.long$risk_perception, vacdf.long$bas, method = "kendall")

risk_bas

bis_vax <- cor.test(vacdf.long$bis, vacdf.long$vax, method = "kendall")

bis_vax

bas_vax <- cor.test(vacdf.long$bas, vacdf.long$vax, method = "kendall")

bas_vax

### Check Ms and SDs

astra %>% 
  get_summary_stats(willingness, type = "mean_sd")

pfizer %>% 
  get_summary_stats(willingness, type = "mean_sd")

vacdf.long %>% 
  get_summary_stats(c(age, frame, risk_perception, bis, bas, vax), type = "mean_sd")


```



```{r}
# Visualise willingness between the vaccines

flexplot(willingness~vaccine, data=vacdf.long, spread="sterr")

flexplot(age~1, data=vacdf.long)

### Univariate plots for astra data

structure(astra)

summary(astra)

## Astra visualisations

flexplot(willingness~1, data=astra)

flexplot(age~1, data=astra)

flexplot(vax~1, data=astra)

flexplot(frame~1, data = astra)

flexplot(bis~1, data = astra)

flexplot(bas~1, data = astra)

flexplot(risk_perception~1, data = astra)

## Bivariate visualisations

flexplot(willingness~age, data = astra)

flexplot(willingness~frame, data = astra)

flexplot(willingness~vax, data = astra)

flexplot(willingness~bis, data = astra)

flexplot(willingness~bas, data = astra)

flexplot(willingness~risk_perception, data = astra)

### Look for interactions for H1 - Age and frame interaction on willingness

astra_p1 = flexplot(willingness~age + frame | vax, data = astra)

marginal_plot(astra_p1)

astra_p2 = flexplot(willingness~age + vax | frame, data = astra)

marginal_plot(astra_p2)

astra_p3 = flexplot(willingness~vax + age | frame, data = astra)

marginal_plot(astra_p3)

astra_p4 = flexplot(willingness~frame + age | vax, data = astra)

marginal_plot(astra_p4)

astra_p5 = flexplot(willingness~vax + frame | age, data = astra)

marginal_plot(astra_p4)





### Alternative hypothesis 1 - less bis and bas with age will have less effect on willingness

astra$bis_scaled <- astra$age - mean(astra$bis, na.rm=TRUE)

astra$bas_scaled <- astra$vax - mean(astra$bas, na.rm=TRUE)


astra_a1 = flexplot(willingness~age + bis | vax, data = astra)

marginal_plot(astra_a1)

astra_a2 = flexplot(willingness~age + vax | bis, data = astra)

marginal_plot(astra_a2)

astra_a3 = flexplot(willingness~bis + age | vax, data = astra)

marginal_plot(astra_a3)

astra_moda1 = lm(willingness~vax_scaled + age_scaled*bis + age_scaled*bas, data = astra)

visualize(astra_moda1)

summary(astra_moda1)

estimates(astra_moda1)



```


```{r}
### Regression analyses on astra data ###



## Centre variables?

astra$age_scaled <- astra$age - mean(astra$age, na.rm=TRUE)

astra$vax_scaled <- astra$vax - mean(astra$vax, na.rm=TRUE)

flexplot(willingness~age_scaled, data = astra) ## The plots do not seem changed by centreing


###  GLM for hypothesis 1 - gain frame messages will increase willingness as age increases (interaction)

astra_mod1 = lm(willingness~vax_scaled + age_scaled*frame, data = astra)

visualize(astra_mod1, plot="model")

visualize(astra_mod1)

## Do not look normal or linear...

 ## create "weights" 

weights = 1 / lm(abs(astra_mod1$residuals) ~ astra_mod1$fitted.values)$fitted.values^2  

  ## fit a new model that weights the residuals

good_model = lm(willingness~vax_scaled + age_scaled*frame, data = astra, weights=weights)

visualize(good_model) ## Doesn't look like it changes much

## Try robust model

astra_mod2 = rlm(willingness~vax_scaled + age_scaled*frame, data = astra)

visualize(astra_mod1, plot = "model")

visualize(astra_mod2, plot = "model")

visualize(astra_mod2, plot = "residuals")

## Try ordinal logistic regression

# Set factors

astra$willingnessfactor <- as.factor(astra$willingness)

levels(astra$willingnessfactor) <-  c("Definitely would not", "Probably would not", "Might or might not", "Probably would", "Definitely would")

astra_mod3 = polr(willingnessfactor~vax_scaled + age_scaled*frame, data = astra, Hess=TRUE)

brant(astra_mod3)

##### Proportional odds assumption violated ######

summary(astra_mod3)

summary(astra_mod2)

### Visualisations of log model

Effect(focal.predictors = "frame",astra_mod3)
plot(Effect(focal.predictors = "age_scaled",astra_mod3))
plot(Effect(focal.predictors = c("frame", "age_scaled"),astra_mod3))

### Try model using vglm as you can specify false for parallel slops

astra_mod4 <- vglm(formula = willingnessfactor~vax_scaled + age_scaled*frame, family = cumulative(parallel = FALSE), 
        data = astra)

summary(astra_mod4)

```



```{r}

flexplot(willingness~risk_perception, data=astra)

flexplot(willingness~bis, data=astra)

flexplot(willingness~bas, data=astra)

flexplot(willingness~vax, data=astra)

flexplot(willingness~vax | age, data = astra, method = "lm")

flexplot(willingness~age + frame, data=astra, method="lm")

## Pannelled plots

flexplot(willingness~age | frame, data=astra)

flexplot(willingness~age + frame | vax, data = astra)

## Quadratic 

flexplot(willingness~age | frame, data=astra, method="quadratic")

added.plot(willingness~age + frame , data=astra, 
           lm_formula = willingness~vax)

## Check if covariate interacts with IVs

flexplot(willingness~vax + age, data=astra, method="lm")
flexplot(willingness~age + vax, data=astra, method="lm") 

# Interaction exists between age and vax

## Check if vax interacts with frame

flexplot(willingness~vax + frame, data=astra, method="lm")
flexplot(willingness~frame + vax, data=astra, method="lm") 

# It does.

flexplot(willingness~age + bis, data=astra, method="lm")

flexplot(willingness~age + bas, data=astra, method="lm")

flexplot(willingness~bis + frame, data=astra, method="lm")

flexplot(willingness~bas + frame, data=astra, method="lm")

```


```{r}
### Pfizer regression analyses ###

## Visualisations

flexplot(willingness~age, data=pfizer)

added.plot(willingness~vax + age, data=pfizer)

flexplot(willingness~frame, data=pfizer)

flexplot(willingness~risk_perception, data=pfizer)

flexplot(willingness~bis, data=pfizer)

flexplot(willingness~bas, data=pfizer)

flexplot(willingness~vax, data=pfizer)

flexplot(willingness~age + frame, data=pfizer, method="lm")

flexplot(willingness~age | bis, data=pfizer, method="lm")

flexplot(willingness~age | bas, data=pfizer, method="lm")

flexplot(willingness~bis + frame, data=pfizer, method="lm")

flexplot(willingness~bas + frame, data=pfizer, method="lm")

```


```{r}
### Astra analyses ###

mod_interaction_az = lm(willingness~vax + frame + age + risk_perception + bis + bas +
                          age*frame + age*bas + age*bis + frame*bis + frame*bas, data = astra)

visualize(mod_interaction_az, plot="residuals")

estimates(mod_interaction_az)

```



```{r}
#### Logistic ordinal regression ####

#Scatter Plot

astra_long <- filter(vacdf.long, vaccine == "will_as_z")

pfizer_long <- filter(vacdf.long, vaccine == "will_pf")

plot(willingness ~ age, data  = astra_long , main = "Scatter Plot")

### Pfizer ###

pfizer_long$willingness <- factor(pfizer_long$willingness)

summary(pfizer_long$willingness)

pfizer_long$frame <- factor(pfizer_long$frame)

summary(pfizer_long$frame)

pfizer_long$risk_perception <- factor(pfizer_long$risk_perception)

summary(pfizer_long$risk_perception)

pf_m1 <- polr(willingness ~ 1, data = pfizer_long, Hess = TRUE)

summary(pf_m1)

## fit ordered logit model and store results 'm'
pf_m2 <- polr(willingness ~ frame + age + risk_perception + 
              bis + bas + vax + age*frame + age*bis + age*bas, 
              data = pfizer_long, Hess=TRUE)

## view a summary of the model
summary(pf_m2)

anova(pf_m1, pf_m2)

## To get pvalues...

(pf_ctable1 <- coef(summary(pf_m2)))

## calculate and store p values
pf_p1 <- pnorm(abs(pf_ctable1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(pf_ctable1 <- cbind(pf_ctable1, "p value" = pf_p1))

## Confidence intervals

(pf_ci <- confint(pf_m2))

## odds ratios
exp(coef(pf_m2))

## Check proportional odds

sf <- function(y){
  c('Y>=1' = qlogis(mean(y >= 1)),
    'Y>=2' = qlogis(mean(y >= 2)),
    'Y>=3' = qlogis(mean(y >= 3)),
    'Y>=4' = qlogis(mean(y >= 4)),
    'Y>=5' = qlogis(mean(y >= 5)))
    }

(s1 <- with(pfizer_long, summary(as.numeric(willingness) ~ frame + age + risk_perception + 
                                   bis + bas + vax + age*frame + age*bis + age*bas, fun=sf)))

glm(I(as.numeric(willingness) >= 3) ~ risk_perception, family="binomial", data = pfizer_long)

glm(I(as.numeric(willingness) >= 4) ~ risk_perception, family="binomial", data = pfizer_long)

## Normalise first set of coefficients to be 0

s1[, 4] <- s1[, 4] - s1[, 3]
s1[, 3] <- s1[, 3] - s1[, 3]
s1 # print

plot(s1, which=1:5, pch=1:3, xlab='logit', main=' ', xlim=range(s1[,3:4]))

## Proportional odds assumption seems violated...

## Trying generalized ordinal model

pf_m3 <- clm(willingness ~ frame + risk_perception + age + bis + bas + vax, nominal = ~ age + bis + bas + vax, data = pfizer_long)

pf_m3

pf_m4 <- oglmx(willingness ~ frame + risk_perception + age + bis + bas + vax +
                age*frame + age*bis + age*bas, data = pfizer_long,
               link="probit", constantMEAN = FALSE, constantSD = FALSE,delta=0,threshparam = NULL)

summary(pf_m4)

```



